---
import Layout from '../../../layouts/Layout.astro';
import queryCMS from '../../../lib/cms';
import { StructuredText } from '@datocms/astro';
import { Image } from '@datocms/astro';
import ImageBlock from '../../../components/blocks/Image.astro';

export async function getStaticPaths() {
  const allProductsQuery = `
    query {
      allProducts {
        slug
      }
    }
  `;
  const { allProducts } = await queryCMS(allProductsQuery);
  return allProducts.map(product => ({ params: { slug: product.slug } }));
}

const { slug } = Astro.params;

const query = `
  query GetProductBySlug($slug: String) {
    product(filter: { slug: { eq: $slug } }) {
      name
      productType
      description {
        value
        blocks {
          ... on RecordInterface {
            id
            __typename
          }
          ... on ImageRecord {
            image {
              url
              alt
            }
          }
        }
      }
      images {
        responsiveImage(imgixParams: { fit: max, auto: format }) {
          src
          width
          height
          alt
          title
          base64
        }
      }
      _seoMetaTags {
        tag
        attributes
        content
      }           
    }
  }
`;

const variables = { slug };
const { product } = await queryCMS(query, variables);

if (!product) {
  return Astro.redirect('/404');
}

---

<Layout additionalSeo={product._seoMetaTags}>
  <div class="container mx-auto px-4 py-8">

    <h1 class="text-4xl font-bold mb-6 uppercase bg-foreground text-background inline-block p-4">{product.title}</h1>
    
    {product.images && product.images.length > 0 && (
      <Image
        data={product.images[0].responsiveImage}
        pictureClass="w-full"
      />          
    )}
    
    <div class="prose prose-invert max-w-none mb-8">
      <StructuredText
        data={product.description}
        blockComponents={
         {
           ImageRecord: ImageBlock
         }}
      />
    </div>
  </div>
</Layout>
